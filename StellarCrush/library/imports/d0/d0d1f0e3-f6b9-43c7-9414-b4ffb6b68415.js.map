{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\Script\\View/assets\\Script\\View\\GridView.js"],"names":["cc","Class","extends","Component","properties","aniPre","default","type","Prefab","effectLayer","Node","audioUtils","AudioUtils","onLoad","setListener","lastTouchPos","Vec2","isCanMove","isInPlayAni","setController","controller","initWithCellModels","cellsModels","cellViews","i","GRID_WIDTH","j","GRID_HEIGHT","aniView","instantiate","parent","node","cellViewScript","getComponent","initWithModel","on","EventType","TOUCH_START","eventTouch","touchPos","getLocation","cellPos","convertTouchPosToCell","changeModels","selectCell","length","TOUCH_END","TOUCH_MOVE","startTouchPos","getStartLocation","startCellPos","x","y","TOUCH_CANCEL","pos","convertToNodeSpace","GRID_PIXEL_WIDTH","GRID_PIXEL_HEIGHT","Math","floor","CELL_WIDTH","CELL_HEIGHT","v2","result","effectsQueue","playEffect","disableTouch","getPlayAniTime","getStep","updateView","cleanCmd","updateSelect","playSwap","playClick","newCellViewInfo","model","viewInfo","findViewByModel","view","cellScript","isDeath","push","forEach","ele","setSelect","maxTime","cmd","playTime","keepTime","reduce","maxValue","efffectCmd","max","step","time","runAction","sequence","delayTime","callFunc","playContinuousMatch","playEffects","resetGrid","director","loadScene"],"mappings":"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","file":"GridView.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\Script\\View","sourcesContent":["import {CELL_WIDTH, CELL_HEIGHT, GRID_PIXEL_WIDTH, GRID_PIXEL_HEIGHT, ANITIME, GRID_HEIGHT, GRID_WIDTH} from '../Model/ConstValue';\n\nimport AudioUtils from \"../Utils/AudioUtils\";\nimport CellModel from '../Model/CellModel';\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        aniPre: {\n            default: [],\n            type: [cc.Prefab]\n        },\n        effectLayer: {\n            default: null,\n            type: cc.Node\n        },\n        audioUtils:{\n            type: AudioUtils,\n            default: null\n        }       \n    },\n\n    \n    onLoad: function () {\n        this.setListener(); \n        this.lastTouchPos = cc.Vec2(-1, -1);\n        this.isCanMove = true;\n        this.isInPlayAni = false; \n        \n    },\n    // 01gamecontroller\n    setController: function(controller){\n        this.controller = controller;\n    },\n    // 02grid cellModels\n    initWithCellModels: function(cellsModels){\n        this.cellViews = [];\n        for(var i = 1;i<=GRID_WIDTH;i++){\n            this.cellViews[i] = [];\n            for(var j = 1;j<=GRID_HEIGHT;j++){\n                var type = cellsModels[i][j].type;\n           \n                var aniView = cc.instantiate(this.aniPre[type]);\n                aniView.parent = this.node;\n                var cellViewScript = aniView.getComponent(\"CellView\");\n                cellViewScript.initWithModel(cellsModels[i][j]);\n                this.cellViews[i][j] = aniView;\n            }\n        }\n    },\n    //Grid \n    setListener: function(){\n     \n        this.node.on(cc.Node.EventType.TOUCH_START, function(eventTouch){\n            if(this.isInPlayAni){\n                return true;\n            }\n            var touchPos = eventTouch.getLocation();\n            var cellPos = this.convertTouchPosToCell(touchPos);\n            if(cellPos){\n                var changeModels = this.selectCell(cellPos);\n                this.isCanMove = changeModels.length < 3;\n            }\n            else{\n                this.isCanMove = false;\n            }\n           return true;\n        }, this);\n\n        this.node.on(cc.Node.EventType.TOUCH_END, function(eventTouch){\n          \n        }, this);\n\n\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, function(eventTouch){\n           if(this.isCanMove){\n               var startTouchPos = eventTouch.getStartLocation ();\n               var startCellPos = this.convertTouchPosToCell(startTouchPos);\n               var touchPos = eventTouch.getLocation();\n               var cellPos = this.convertTouchPosToCell(touchPos);\n               if(startCellPos.x != cellPos.x || startCellPos.y != cellPos.y){\n                   this.isCanMove = false;\n                   var changeModels = this.selectCell(cellPos); \n               }\n           }\n        }, this);\n\n        this.node.on(cc.Node.EventType.TOUCH_CANCEL, function(eventTouch){\n   \n        }, this);\n    },\n\n\n    convertTouchPosToCell: function(pos){\n        pos = this.node.convertToNodeSpace(pos);\n        if(pos.x < 0 || pos.x >= GRID_PIXEL_WIDTH || pos.y < 0 || pos.y >= GRID_PIXEL_HEIGHT){\n            return false; \n        }\n        var x = Math.floor(pos.x / CELL_WIDTH) + 1;\n        var y = Math.floor(pos.y / CELL_HEIGHT) + 1;\n        return cc.v2(x, y);\n    },\n\n    selectCell: function(cellPos){\n        var result = this.controller.selectCell(cellPos); \n        var changeModels = result[0]; \n        var effectsQueue = result[1]; \n        this.playEffect(effectsQueue); \n        this.disableTouch(this.getPlayAniTime(changeModels), this.getStep(effectsQueue));\n        this.updateView(changeModels);\n        this.controller.cleanCmd(); \n        if(changeModels.length >= 2){\n            this.updateSelect(cc.v2(-1,-1));\n            this.audioUtils.playSwap();\n        }\n        else{\n            this.updateSelect(cellPos);\n            this.audioUtils.playClick();\n        }\n        return changeModels;\n    },\n\n    updateView: function(changeModels){\n        let newCellViewInfo = [];\n        for(var i in changeModels){\n            var model = changeModels[i];\n            var viewInfo = this.findViewByModel(model);\n            var view = null;\n\n            if(!viewInfo){\n                var type = model.type;\n                var aniView = cc.instantiate(this.aniPre[type]);\n                aniView.parent = this.node;\n                var cellViewScript = aniView.getComponent(\"CellView\");\n                cellViewScript.initWithModel(model);\n                view = aniView;\n            }\n\n            else{\n                view = viewInfo.view;\n                this.cellViews[viewInfo.y][viewInfo.x] = null;\n            }\n            var cellScript = view.getComponent(\"CellView\");\n            cellScript.updateView();\n            if (!model.isDeath) {\n                newCellViewInfo.push({\n                    model: model,\n                    view: view\n                });\n            } \n        }\n\n        newCellViewInfo.forEach(function(ele){\n            let model = ele.model;\n            this.cellViews[model.y][model.x] = ele.view;\n        },this);\n    },\n\n    updateSelect: function(pos){\n         for(var i = 1;i <=GRID_WIDTH;i++){\n            for(var j = 1 ;j <=GRID_HEIGHT;j ++){\n                if(this.cellViews[i][j]){\n                    var cellScript = this.cellViews[i][j].getComponent(\"CellView\");\n                    if(pos.x == j && pos.y ==i){\n                        cellScript.setSelect(true);\n                    }\n                    else{\n                        cellScript.setSelect(false);\n                    }\n                }\n            }\n        }        \n    },\n\n    findViewByModel: function(model){\n        for(var i = 1;i <=GRID_WIDTH ;i++){\n            for(var j = 1 ;j <=GRID_HEIGHT ;j ++){\n                if(this.cellViews[i][j] && this.cellViews[i][j].getComponent(\"CellView\").model == model){\n                    return {view:this.cellViews[i][j],x:j, y:i};\n                }\n            }\n        }\n        return null;\n    },\n\n    getPlayAniTime: function(changeModels){\n        if(!changeModels){\n            return 0;\n        }\n        var maxTime = 0;\n        changeModels.forEach(function(ele){\n            ele.cmd.forEach(function(cmd){\n                if(maxTime < cmd.playTime + cmd.keepTime){\n                    maxTime = cmd.playTime + cmd.keepTime;\n                }\n            },this)\n        },this);\n        return maxTime;\n    },\n\n    getStep: function(effectsQueue){\n        if(!effectsQueue){\n            return 0;\n        }\n        return effectsQueue.reduce(function(maxValue, efffectCmd){\n            return Math.max(maxValue, efffectCmd.step || 0);\n        }, 0);\n    },\n\n    disableTouch: function(time, step){\n        if(time <= 0){\n            return ;\n        }\n        this.isInPlayAni = true;\n        this.node.runAction(cc.sequence(cc.delayTime(time),cc.callFunc(function(){\n            this.isInPlayAni = false;\n            this.audioUtils.playContinuousMatch(step);\n        }, this)));\n    },\n\n\n    playEffect: function(effectsQueue){\n        this.effectLayer.getComponent(\"EffectLayer\").playEffects(effectsQueue);\n        \n    },\n\n    // update: function (dt) {\n\n    // }\n    \n    resetGrid:function(){\n        cc.director.loadScene('Game');\n\n    }\n});\n\n\n"]}